<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Inspection Page</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="company-banner">Construction Quality Control</span>
        </div>
        <div class="nav-tabs">
            <a href="framing-reports.html" class="nav-tab active">Framing</a>
            <a href="#" class="nav-tab">Electrical</a>
            <a href="#" class="nav-tab">Plumbing</a>
            <a href="#" class="nav-tab">HVAC</a>
        </div>
    </nav>

    <div class="container">
        <header>
            <div class="header-flex">
                <h1>Framing Quality Control</h1>
            </div>
            <p>Inspect and mark items as pass or fail</p>
        </header>

        <main>
            <div class="inspection-list">
                <h2>Inspection Checklist</h2>
                <div id="items-container">
                    <!-- Items will be dynamically added here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // Sample inspection items
        const sampleItems = [
            { id: 1, name: "Wall Plate Alignment", description: "Check that wall plates are properly aligned" },
            { id: 2, name: "Stud Spacing", description: "Verify studs are spaced correctly (16\" or 24\" OC)" },
            { id: 3, name: "Top Plate Overlap", description: "Ensure top plates overlap at corners and T-joints" },
            { id: 4, name: "Bracing Installation", description: "Check that bracing is properly installed" },
            { id: 5, name: "Rough Opening Dimensions", description: "Verify door/window openings are correct size" },
            { id: 6, name: "Header Installation", description: "Check headers are properly sized and installed" },
            { id: 7, name: "Sill Sealing", description: "Ensure sill plates are properly sealed" },
            { id: 8, name: "Lateral Restraint", description: "Verify lateral restraint is properly installed" }
        ];

        // DOM elements
        const itemsContainer = document.getElementById('items-container');

        // Mock localStorage data for testing
        localStorage.setItem('inspectionResults', JSON.stringify({
            1: 'fail',
            2: 'pass',
            3: 'fail'
        }));
        
        localStorage.setItem('storedDeficiencyDescriptions', JSON.stringify({
            1: ['Wall plate not properly aligned with foundation anchor bolts', 'Gap exceeds 1/4 inch tolerance'],
            3: ['Top plates do not overlap at corner joint']
        }));

        // Get saved results from localStorage
        const savedResults = JSON.parse(localStorage.getItem('inspectionResults') || '{}');
        const storedDescriptions = JSON.parse(localStorage.getItem('storedDeficiencyDescriptions') || '{}');

        // Create and display items
        sampleItems.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'inspection-item';

            // Get saved status for this item, default to 'pending'
            const savedStatus = savedResults[item.id] || 'pending';

            itemElement.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-description">${item.description}</div>
                </div>
                <div class="button-group">
                    <button class="btn-pass ${savedStatus === 'pass' ? 'active' : ''}" data-id="${item.id}">PASS</button>
                    <button class="btn-fail ${savedStatus === 'fail' ? 'active' : ''}" data-id="${item.id}">FAIL</button>
                </div>
            `;
            itemElement.setAttribute('data-id', item.id);

            itemsContainer.appendChild(itemElement);

            // If the item is marked as failed and has stored descriptions, show them
            if (savedStatus === 'fail' && storedDescriptions[item.id] && storedDescriptions[item.id].length > 0) {
                // Create the deficiency display section with collapsible header
                const deficiencyDisplay = document.createElement('div');
                deficiencyDisplay.id = `deficiency-display-${item.id}`;
                deficiencyDisplay.className = 'deficiency-display';

                // Create header with toggle
                const displayHeader = document.createElement('div');
                displayHeader.className = 'deficiency-display-header';
                displayHeader.innerHTML = `
                    <h4>Added Deficiencies</h4>
                    <button type="button" class="toggle-button" data-target="deficiency-display-content-${item.id}">
                        <span class="toggle-icon">▼</span>
                    </button>
                `;

                deficiencyDisplay.appendChild(displayHeader);

                // Create content section
                const displayContent = document.createElement('div');
                displayContent.id = `deficiency-display-content-${item.id}`;
                displayContent.className = 'deficiency-display-content';

                // Add each stored description
                storedDescriptions[item.id].forEach(desc => {
                    const descParagraph = document.createElement('p');
                    descParagraph.textContent = desc;
                    displayContent.appendChild(descParagraph);
                });

                deficiencyDisplay.appendChild(displayContent);

                itemElement.appendChild(deficiencyDisplay);

                // Add toggle functionality to the display section
                const displayToggle = displayHeader.querySelector('.toggle-button');
                displayToggle.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    
                    if (targetElement.style.display === 'none') {
                        targetElement.style.display = 'block';
                        this.querySelector('.toggle-icon').textContent = '▼';
                    } else {
                        targetElement.style.display = 'none';
                        this.querySelector('.toggle-icon').textContent = '▶';
                    }
                });
            }
        });

        // Initialize collapsible sections
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial state for all toggle icons to collapsed (▶)
            const toggleIcons = document.querySelectorAll('.toggle-icon');
            toggleIcons.forEach(icon => {
                if (!icon.dataset.initialized) {
                    icon.textContent = '▶'; // Default to collapsed
                    icon.dataset.initialized = 'true';
                }
            });
            
            // Also hide the content sections by default
            const contentSections = document.querySelectorAll('.deficiency-content, .deficiency-display-content, .additional-descriptions-content');
            contentSections.forEach(section => {
                section.style.display = 'none';
            });
        });

        // Handle PASS button click
        document.querySelectorAll('.btn-pass').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = parseInt(this.getAttribute('data-id'));
                
                // Remove any existing deficiency sections
                const existingDescSection = document.getElementById(`deficiency-desc-${itemId}`);
                if (existingDescSection) {
                    existingDescSection.remove();
                }
                
                // Remove any existing display sections
                const existingDisplaySection = document.getElementById(`deficiency-display-${itemId}`);
                if (existingDisplaySection) {
                    existingDisplaySection.remove();
                }
                
                // Update button states
                this.classList.add('active');
                const failBtn = document.querySelector(`.btn-fail[data-id="${itemId}"]`);
                if (failBtn) failBtn.classList.remove('active');
                
                // Save the result
                saveResult(itemId, 'pass');
            });
        });

        // Handle FAIL button click
        document.querySelectorAll('.btn-fail').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = parseInt(this.getAttribute('data-id'));
                
                // Update button states
                this.classList.add('active');
                const passBtn = document.querySelector(`.btn-pass[data-id="${itemId}"]`);
                if (passBtn) passBtn.classList.remove('active');
                
                // Save the result
                saveResult(itemId, 'fail');
                
                // Show the deficiency description section for this item
                showDeficiencyDescriptionSection(itemId);
            });
        });

        // Show the deficiency description section for a specific item
        function showDeficiencyDescriptionSection(itemId) {
            const itemElement = document.querySelector(`.inspection-item[data-id="${itemId}"]`);
            if (!itemElement) return;

            // Check if the section already exists
            const existingSection = document.getElementById(`deficiency-desc-${itemId}`);
            if (existingSection) {
                existingSection.style.display = 'block';
                return;
            }

            // Create the deficiency description section
            const deficiencySection = document.createElement('div');
            deficiencySection.id = `deficiency-desc-${itemId}`;
            deficiencySection.className = 'deficiency-description-section';

            // Create the header with toggle button
            const headerSection = document.createElement('div');
            headerSection.className = 'deficiency-header';
            headerSection.innerHTML = `
                <h4>Deficiency Details</h4>
                <button type="button" class="toggle-button" data-target="deficiency-desc-content-${itemId}">
                    <span class="toggle-icon">▼</span>
                </button>
            `;

            // Create the content section
            const contentSection = document.createElement('div');
            contentSection.id = `deficiency-desc-content-${itemId}`;
            contentSection.className = 'deficiency-content';

            contentSection.innerHTML = `
                <div class="deficiency-input-container">
                    <label for="deficiency-desc-input-${itemId}">Deficiency Description:</label>
                    <textarea id="deficiency-desc-input-${itemId}" placeholder="Describe the deficiency..."></textarea>
                    <button class="btn-ok" data-id="${itemId}">OK</button>
                </div>
            `;

            deficiencySection.appendChild(headerSection);
            deficiencySection.appendChild(contentSection);

            itemElement.appendChild(deficiencySection);

            // Add event listener to the toggle button
            const toggleButton = headerSection.querySelector('.toggle-button');
            toggleButton.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);
                
                if (targetElement.style.display === 'none') {
                    targetElement.style.display = 'block';
                    this.querySelector('.toggle-icon').textContent = '▼';
                } else {
                    targetElement.style.display = 'none';
                    this.querySelector('.toggle-icon').textContent = '▶';
                }
            });

            // Add event listener to the OK button
            const okButton = contentSection.querySelector('.btn-ok');
            okButton.addEventListener('click', function() {
                const descInput = document.getElementById(`deficiency-desc-input-${itemId}`);
                const description = descInput.value.trim();

                if (description) {
                    // Store the description in localStorage
                    storeDeficiencyDescription(itemId, description);

                    // Find the item element again to append the display
                    const itemEl = document.querySelector(`.inspection-item[data-id="${itemId}"]`);

                    // Create a display div if it doesn't exist
                    let displayDiv = document.getElementById(`deficiency-display-${itemId}`);
                    if (!displayDiv) {
                        displayDiv = document.createElement('div');
                        
                        // Create header with toggle for the display section too
                        const displayHeader = document.createElement('div');
                        displayHeader.className = 'deficiency-display-header';
                        displayHeader.innerHTML = `
                            <h4>Added Deficiencies</h4>
                            <button type="button" class="toggle-button" data-target="deficiency-display-content-${itemId}">
                                <span class="toggle-icon">▼</span>
                            </button>
                        `;
                        
                        displayDiv.appendChild(displayHeader);
                        
                        const displayContent = document.createElement('div');
                        displayContent.id = `deficiency-display-content-${itemId}`;
                        displayContent.className = 'deficiency-display-content';
                        displayDiv.id = `deficiency-display-${itemId}`;
                        displayDiv.className = 'deficiency-display';
                        
                        displayDiv.appendChild(displayContent);
                        
                        itemEl.appendChild(displayDiv);
                        
                        // Add toggle functionality to the display section
                        const displayToggle = displayHeader.querySelector('.toggle-button');
                        displayToggle.addEventListener('click', function() {
                            const targetId = this.getAttribute('data-target');
                            const targetElement = document.getElementById(targetId);
                            
                            if (targetElement.style.display === 'none') {
                                targetElement.style.display = 'block';
                                this.querySelector('.toggle-icon').textContent = '▼';
                            } else {
                                targetElement.style.display = 'none';
                                this.querySelector('.toggle-icon').textContent = '▶';
                            }
                        });
                    }

                    // Add the description to the display content
                    const descParagraph = document.createElement('p');
                    descParagraph.textContent = description;
                    const displayContent = displayDiv.querySelector('.deficiency-display-content');
                    displayContent.appendChild(descParagraph);

                    // Clear the input field
                    descInput.value = '';

                    // Hide the input section after adding the description
                    contentSection.style.display = 'none';
                    
                    // Update toggle icon to reflect hidden state
                    toggleButton.querySelector('.toggle-icon').textContent = '▶';
                }
            });
        }

        // Store deficiency description in localStorage
        function storeDeficiencyDescription(itemId, description) {
            let storedDescriptions = JSON.parse(localStorage.getItem('storedDeficiencyDescriptions') || '{}');
            if (!storedDescriptions[itemId]) {
                storedDescriptions[itemId] = [];
            }
            storedDescriptions[itemId].push(description);
            localStorage.setItem('storedDeficiencyDescriptions', JSON.stringify(storedDescriptions));
        }

        // Save result to localStorage
        function saveResult(itemId, status) {
            let results = JSON.parse(localStorage.getItem('inspectionResults') || '{}');
            results[itemId] = status;
            localStorage.setItem('inspectionResults', JSON.stringify(results));
        }
    </script>
</body>
</html>